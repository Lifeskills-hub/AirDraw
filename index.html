<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Finger Drawing with Camera</title>
    
    <!-- WORKING VERSION - Fixed & maintained fork -->
    <script src="https://cdn.jsdelivr.net/npm/@tensor4all/handtrack.js@0.0.16/dist/handtrack.min.js"></script>
    
    <style>
        body { margin:0; background:black; overflow:hidden; }
        #video { width:100vw; height:100vh; object-fit:cover; }
        #canvas { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; }
        #controls {
            position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
            display:flex; gap:20px; z-index:10;
        }
        button {
            width:70px; height:70px; border-radius:50%; border:none; font-weight:bold; color:white;
        }
        #clear { background:#333; width:100px; border-radius:40px; }
    </style>
</head>
<body>
<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>
<div id="controls">
    <button style="background:#000">Black</button>
    <button style="background:#ffff00;color:#000">Yellow</button>
    <button style="background:#ff0000">Red</button>
    <button style="background:#00ff00">Green</button>
    <button id="clear">CLEAR ALL</button>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let model = null;
    let currentColor = 'yellow';
    let lastX = 0, lastY = 0;
    let isDrawing = false;

    const modelParams = {
        flipHorizontal: true,
        maxNumBoxes: 1,
        iouThreshold: 0.5,
        scoreThreshold: 0.7,
    };

    // This will now work!
    handtrack.load(modelParams).then(lmodel => {
        model = lmodel;
        console.log("Handtrack model loaded!");
        startVideo();
    }).catch(err => {
        console.error("Failed to load model:", err);
        alert("Failed to load hand detection model. Check console.");
    });

    function startVideo() {
        handtrack.startVideo(video).then(status => {
            if (status) {
                console.log("Camera started");
                runDetection();
            } else {
                alert("Please allow camera access");
            }
        });
    }

    function runDetection() {
        if (!model) return;

        model.detect(video).then(predictions => {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // optional: remove trails for cleaner look
            if (predictions.length > 0) {
                const bbox = predictions[0].bbox; // [x, y, width, height]
                const centerX = bbox[0] + bbox[2] / 2;
                const centerY = bbox[1] + bbox[3] / 2;

                const x = (centerX / video.videoWidth) * canvas.width;
                const y = (centerY / video.videoHeight) * canvas.height;

                // Visual feedback dot
                ctx.fillStyle = currentColor;
                ctx.beginPath();
                ctx.arc(x, y, 18, 0, Math.PI * 2);
                ctx.fill();

                // Draw line if moving
                if (isDrawing && lastX && lastY) {
                    ctx.lineWidth = 14;
                    ctx.lineCap = 'round';
                    ctx.strokeStyle = currentColor;
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                }

                lastX = x;
                lastY = y;
                isDrawing = true;
            } else {
                isDrawing = false;
            }

            requestAnimationFrame(runDetection);
        });
    }

    // Color buttons
    document.querySelectorAll('#controls button:not(#clear)').forEach(btn => {
        btn.onclick = () => {
            currentColor = btn.style.backgroundColor;
            if (currentColor === 'black') currentColor = '#000';
            if (currentColor === 'rgb(255, 255, 0)') currentColor = 'yellow'; // fix yellow
        };
    });

    document.getElementById('clear').onclick = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
</script>
</body>
</html>
